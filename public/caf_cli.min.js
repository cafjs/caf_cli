require=function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var util=require("util/");var pSlice=Array.prototype.slice;var hasOwn=Object.prototype.hasOwnProperty;var assert=module.exports=ok;assert.AssertionError=function AssertionError(options){this.name="AssertionError";this.actual=options.actual;this.expected=options.expected;this.operator=options.operator;if(options.message){this.message=options.message;this.generatedMessage=false}else{this.message=getMessage(this);this.generatedMessage=true}var stackStartFunction=options.stackStartFunction||fail;if(Error.captureStackTrace){Error.captureStackTrace(this,stackStartFunction)}else{var err=new Error;if(err.stack){var out=err.stack;var fn_name=stackStartFunction.name;var idx=out.indexOf("\n"+fn_name);if(idx>=0){var next_line=out.indexOf("\n",idx+1);out=out.substring(next_line+1)}this.stack=out}}};util.inherits(assert.AssertionError,Error);function replacer(key,value){if(util.isUndefined(value)){return""+value}if(util.isNumber(value)&&!isFinite(value)){return value.toString()}if(util.isFunction(value)||util.isRegExp(value)){return value.toString()}return value}function truncate(s,n){if(util.isString(s)){return s.length<n?s:s.slice(0,n)}else{return s}}function getMessage(self){return truncate(JSON.stringify(self.actual,replacer),128)+" "+self.operator+" "+truncate(JSON.stringify(self.expected,replacer),128)}function fail(actual,expected,message,operator,stackStartFunction){throw new assert.AssertionError({message:message,actual:actual,expected:expected,operator:operator,stackStartFunction:stackStartFunction})}assert.fail=fail;function ok(value,message){if(!value)fail(value,true,message,"==",assert.ok)}assert.ok=ok;assert.equal=function equal(actual,expected,message){if(actual!=expected)fail(actual,expected,message,"==",assert.equal)};assert.notEqual=function notEqual(actual,expected,message){if(actual==expected){fail(actual,expected,message,"!=",assert.notEqual)}};assert.deepEqual=function deepEqual(actual,expected,message){if(!_deepEqual(actual,expected)){fail(actual,expected,message,"deepEqual",assert.deepEqual)}};function _deepEqual(actual,expected){if(actual===expected){return true}else if(util.isBuffer(actual)&&util.isBuffer(expected)){if(actual.length!=expected.length)return false;for(var i=0;i<actual.length;i++){if(actual[i]!==expected[i])return false}return true}else if(util.isDate(actual)&&util.isDate(expected)){return actual.getTime()===expected.getTime()}else if(util.isRegExp(actual)&&util.isRegExp(expected)){return actual.source===expected.source&&actual.global===expected.global&&actual.multiline===expected.multiline&&actual.lastIndex===expected.lastIndex&&actual.ignoreCase===expected.ignoreCase}else if(!util.isObject(actual)&&!util.isObject(expected)){return actual==expected}else{return objEquiv(actual,expected)}}function isArguments(object){return Object.prototype.toString.call(object)=="[object Arguments]"}function objEquiv(a,b){if(util.isNullOrUndefined(a)||util.isNullOrUndefined(b))return false;if(a.prototype!==b.prototype)return false;if(util.isPrimitive(a)||util.isPrimitive(b)){return a===b}var aIsArgs=isArguments(a),bIsArgs=isArguments(b);if(aIsArgs&&!bIsArgs||!aIsArgs&&bIsArgs)return false;if(aIsArgs){a=pSlice.call(a);b=pSlice.call(b);return _deepEqual(a,b)}var ka=objectKeys(a),kb=objectKeys(b),key,i;if(ka.length!=kb.length)return false;ka.sort();kb.sort();for(i=ka.length-1;i>=0;i--){if(ka[i]!=kb[i])return false}for(i=ka.length-1;i>=0;i--){key=ka[i];if(!_deepEqual(a[key],b[key]))return false}return true}assert.notDeepEqual=function notDeepEqual(actual,expected,message){if(_deepEqual(actual,expected)){fail(actual,expected,message,"notDeepEqual",assert.notDeepEqual)}};assert.strictEqual=function strictEqual(actual,expected,message){if(actual!==expected){fail(actual,expected,message,"===",assert.strictEqual)}};assert.notStrictEqual=function notStrictEqual(actual,expected,message){if(actual===expected){fail(actual,expected,message,"!==",assert.notStrictEqual)}};function expectedException(actual,expected){if(!actual||!expected){return false}if(Object.prototype.toString.call(expected)=="[object RegExp]"){return expected.test(actual)}else if(actual instanceof expected){return true}else if(expected.call({},actual)===true){return true}return false}function _throws(shouldThrow,block,expected,message){var actual;if(util.isString(expected)){message=expected;expected=null}try{block()}catch(e){actual=e}message=(expected&&expected.name?" ("+expected.name+").":".")+(message?" "+message:".");if(shouldThrow&&!actual){fail(actual,expected,"Missing expected exception"+message)}if(!shouldThrow&&expectedException(actual,expected)){fail(actual,expected,"Got unwanted exception"+message)}if(shouldThrow&&actual&&expected&&!expectedException(actual,expected)||!shouldThrow&&actual){throw actual}}assert.throws=function(block,error,message){_throws.apply(this,[true].concat(pSlice.call(arguments)))};assert.doesNotThrow=function(block,message){_throws.apply(this,[false].concat(pSlice.call(arguments)))};assert.ifError=function(err){if(err){throw err}};var objectKeys=Object.keys||function(obj){var keys=[];for(var key in obj){if(hasOwn.call(obj,key))keys.push(key)}return keys}},{"util/":10}],2:[function(require,module,exports){if(typeof Object.create==="function"){module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;ctor.prototype=Object.create(superCtor.prototype,{constructor:{value:ctor,enumerable:false,writable:true,configurable:true}})}}else{module.exports=function inherits(ctor,superCtor){ctor.super_=superCtor;var TempCtor=function(){};TempCtor.prototype=superCtor.prototype;ctor.prototype=new TempCtor;ctor.prototype.constructor=ctor}}},{}],3:[function(require,module,exports){var process=module.exports={};var queue=[];var draining=false;function drainQueue(){if(draining){return}draining=true;var currentQueue;var len=queue.length;while(len){currentQueue=queue;queue=[];var i=-1;while(++i<len){currentQueue[i]()}len=queue.length}draining=false}process.nextTick=function(fun){queue.push(fun);if(!draining){setTimeout(drainQueue,0)}};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";process.versions={};function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}],4:[function(require,module,exports){(function(global){(function(root){var freeExports=typeof exports=="object"&&exports;var freeModule=typeof module=="object"&&module&&module.exports==freeExports&&module;var freeGlobal=typeof global=="object"&&global;if(freeGlobal.global===freeGlobal||freeGlobal.window===freeGlobal){root=freeGlobal}var punycode,maxInt=2147483647,base=36,tMin=1,tMax=26,skew=38,damp=700,initialBias=72,initialN=128,delimiter="-",regexPunycode=/^xn--/,regexNonASCII=/[^ -~]/,regexSeparators=/\x2E|\u3002|\uFF0E|\uFF61/g,errors={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},baseMinusTMin=base-tMin,floor=Math.floor,stringFromCharCode=String.fromCharCode,key;function error(type){throw RangeError(errors[type])}function map(array,fn){var length=array.length;while(length--){array[length]=fn(array[length])}return array}function mapDomain(string,fn){return map(string.split(regexSeparators),fn).join(".")}function ucs2decode(string){var output=[],counter=0,length=string.length,value,extra;while(counter<length){value=string.charCodeAt(counter++);if(value>=55296&&value<=56319&&counter<length){extra=string.charCodeAt(counter++);if((extra&64512)==56320){output.push(((value&1023)<<10)+(extra&1023)+65536)}else{output.push(value);counter--}}else{output.push(value)}}return output}function ucs2encode(array){return map(array,function(value){var output="";if(value>65535){value-=65536;output+=stringFromCharCode(value>>>10&1023|55296);value=56320|value&1023}output+=stringFromCharCode(value);return output}).join("")}function basicToDigit(codePoint){if(codePoint-48<10){return codePoint-22}if(codePoint-65<26){return codePoint-65}if(codePoint-97<26){return codePoint-97}return base}function digitToBasic(digit,flag){return digit+22+75*(digit<26)-((flag!=0)<<5)}function adapt(delta,numPoints,firstTime){var k=0;delta=firstTime?floor(delta/damp):delta>>1;delta+=floor(delta/numPoints);for(;delta>baseMinusTMin*tMax>>1;k+=base){delta=floor(delta/baseMinusTMin)}return floor(k+(baseMinusTMin+1)*delta/(delta+skew))}function decode(input){var output=[],inputLength=input.length,out,i=0,n=initialN,bias=initialBias,basic,j,index,oldi,w,k,digit,t,baseMinusT;basic=input.lastIndexOf(delimiter);if(basic<0){basic=0}for(j=0;j<basic;++j){if(input.charCodeAt(j)>=128){error("not-basic")}output.push(input.charCodeAt(j))}for(index=basic>0?basic+1:0;index<inputLength;){for(oldi=i,w=1,k=base;;k+=base){if(index>=inputLength){error("invalid-input")}digit=basicToDigit(input.charCodeAt(index++));if(digit>=base||digit>floor((maxInt-i)/w)){error("overflow")}i+=digit*w;t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(digit<t){break}baseMinusT=base-t;if(w>floor(maxInt/baseMinusT)){error("overflow")}w*=baseMinusT}out=output.length+1;bias=adapt(i-oldi,out,oldi==0);if(floor(i/out)>maxInt-n){error("overflow")}n+=floor(i/out);i%=out;output.splice(i++,0,n)}return ucs2encode(output)}function encode(input){var n,delta,handledCPCount,basicLength,bias,j,m,q,k,t,currentValue,output=[],inputLength,handledCPCountPlusOne,baseMinusT,qMinusT;input=ucs2decode(input);inputLength=input.length;n=initialN;delta=0;bias=initialBias;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<128){output.push(stringFromCharCode(currentValue))}}handledCPCount=basicLength=output.length;if(basicLength){output.push(delimiter)}while(handledCPCount<inputLength){for(m=maxInt,j=0;j<inputLength;++j){currentValue=input[j];if(currentValue>=n&&currentValue<m){m=currentValue}}handledCPCountPlusOne=handledCPCount+1;if(m-n>floor((maxInt-delta)/handledCPCountPlusOne)){error("overflow")}delta+=(m-n)*handledCPCountPlusOne;n=m;for(j=0;j<inputLength;++j){currentValue=input[j];if(currentValue<n&&++delta>maxInt){error("overflow")}if(currentValue==n){for(q=delta,k=base;;k+=base){t=k<=bias?tMin:k>=bias+tMax?tMax:k-bias;if(q<t){break}qMinusT=q-t;baseMinusT=base-t;output.push(stringFromCharCode(digitToBasic(t+qMinusT%baseMinusT,0)));q=floor(qMinusT/baseMinusT)}output.push(stringFromCharCode(digitToBasic(q,0)));bias=adapt(delta,handledCPCountPlusOne,handledCPCount==basicLength);delta=0;++handledCPCount}}++delta;++n}return output.join("")}function toUnicode(domain){return mapDomain(domain,function(string){return regexPunycode.test(string)?decode(string.slice(4).toLowerCase()):string})}function toASCII(domain){return mapDomain(domain,function(string){return regexNonASCII.test(string)?"xn--"+encode(string):string})}punycode={version:"1.2.4",ucs2:{decode:ucs2decode,encode:ucs2encode},decode:decode,encode:encode,toASCII:toASCII,toUnicode:toUnicode};if(typeof define=="function"&&typeof define.amd=="object"&&define.amd){define("punycode",function(){return punycode})}else if(freeExports&&!freeExports.nodeType){if(freeModule){freeModule.exports=punycode}else{for(key in punycode){punycode.hasOwnProperty(key)&&(freeExports[key]=punycode[key])}}}else{root.punycode=punycode}})(this)}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{}],5:[function(require,module,exports){"use strict";function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}module.exports=function(qs,sep,eq,options){sep=sep||"&";eq=eq||"=";var obj={};if(typeof qs!=="string"||qs.length===0){return obj}var regexp=/\+/g;qs=qs.split(sep);var maxKeys=1e3;if(options&&typeof options.maxKeys==="number"){maxKeys=options.maxKeys}var len=qs.length;if(maxKeys>0&&len>maxKeys){len=maxKeys}for(var i=0;i<len;++i){var x=qs[i].replace(regexp,"%20"),idx=x.indexOf(eq),kstr,vstr,k,v;if(idx>=0){kstr=x.substr(0,idx);vstr=x.substr(idx+1)}else{kstr=x;vstr=""}k=decodeURIComponent(kstr);v=decodeURIComponent(vstr);if(!hasOwnProperty(obj,k)){obj[k]=v}else if(isArray(obj[k])){obj[k].push(v)}else{obj[k]=[obj[k],v]}}return obj};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"}},{}],6:[function(require,module,exports){"use strict";var stringifyPrimitive=function(v){switch(typeof v){case"string":return v;case"boolean":return v?"true":"false";case"number":return isFinite(v)?v:"";default:return""}};module.exports=function(obj,sep,eq,name){sep=sep||"&";eq=eq||"=";if(obj===null){obj=undefined}if(typeof obj==="object"){return map(objectKeys(obj),function(k){var ks=encodeURIComponent(stringifyPrimitive(k))+eq;if(isArray(obj[k])){return map(obj[k],function(v){return ks+encodeURIComponent(stringifyPrimitive(v))}).join(sep)}else{return ks+encodeURIComponent(stringifyPrimitive(obj[k]))}}).join(sep)}if(!name)return"";return encodeURIComponent(stringifyPrimitive(name))+eq+encodeURIComponent(stringifyPrimitive(obj))};var isArray=Array.isArray||function(xs){return Object.prototype.toString.call(xs)==="[object Array]"};function map(xs,f){if(xs.map)return xs.map(f);var res=[];for(var i=0;i<xs.length;i++){res.push(f(xs[i],i))}return res}var objectKeys=Object.keys||function(obj){var res=[];for(var key in obj){if(Object.prototype.hasOwnProperty.call(obj,key))res.push(key)}return res}},{}],7:[function(require,module,exports){"use strict";exports.decode=exports.parse=require("./decode");exports.encode=exports.stringify=require("./encode")},{"./decode":5,"./encode":6}],8:[function(require,module,exports){var punycode=require("punycode");exports.parse=urlParse;exports.resolve=urlResolve;exports.resolveObject=urlResolveObject;exports.format=urlFormat;exports.Url=Url;function Url(){this.protocol=null;this.slashes=null;this.auth=null;this.host=null;this.port=null;this.hostname=null;this.hash=null;this.search=null;this.query=null;this.pathname=null;this.path=null;this.href=null}var protocolPattern=/^([a-z0-9.+-]+:)/i,portPattern=/:[0-9]*$/,delims=["<",">",'"',"`"," ","\r","\n","	"],unwise=["{","}","|","\\","^","`"].concat(delims),autoEscape=["'"].concat(unwise),nonHostChars=["%","/","?",";","#"].concat(autoEscape),hostEndingChars=["/","?","#"],hostnameMaxLen=255,hostnamePartPattern=/^[a-z0-9A-Z_-]{0,63}$/,hostnamePartStart=/^([a-z0-9A-Z_-]{0,63})(.*)$/,unsafeProtocol={javascript:true,"javascript:":true},hostlessProtocol={javascript:true,"javascript:":true},slashedProtocol={http:true,https:true,ftp:true,gopher:true,file:true,"http:":true,"https:":true,"ftp:":true,"gopher:":true,"file:":true},querystring=require("querystring");function urlParse(url,parseQueryString,slashesDenoteHost){if(url&&isObject(url)&&url instanceof Url)return url;var u=new Url;u.parse(url,parseQueryString,slashesDenoteHost);return u}Url.prototype.parse=function(url,parseQueryString,slashesDenoteHost){if(!isString(url)){throw new TypeError("Parameter 'url' must be a string, not "+typeof url)}var rest=url;rest=rest.trim();var proto=protocolPattern.exec(rest);if(proto){proto=proto[0];var lowerProto=proto.toLowerCase();this.protocol=lowerProto;rest=rest.substr(proto.length)}if(slashesDenoteHost||proto||rest.match(/^\/\/[^@\/]+@[^@\/]+/)){var slashes=rest.substr(0,2)==="//";if(slashes&&!(proto&&hostlessProtocol[proto])){rest=rest.substr(2);this.slashes=true}}if(!hostlessProtocol[proto]&&(slashes||proto&&!slashedProtocol[proto])){var hostEnd=-1;for(var i=0;i<hostEndingChars.length;i++){var hec=rest.indexOf(hostEndingChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}var auth,atSign;if(hostEnd===-1){atSign=rest.lastIndexOf("@")}else{atSign=rest.lastIndexOf("@",hostEnd)}if(atSign!==-1){auth=rest.slice(0,atSign);rest=rest.slice(atSign+1);this.auth=decodeURIComponent(auth)}hostEnd=-1;for(var i=0;i<nonHostChars.length;i++){var hec=rest.indexOf(nonHostChars[i]);if(hec!==-1&&(hostEnd===-1||hec<hostEnd))hostEnd=hec}if(hostEnd===-1)hostEnd=rest.length;this.host=rest.slice(0,hostEnd);rest=rest.slice(hostEnd);this.parseHost();this.hostname=this.hostname||"";var ipv6Hostname=this.hostname[0]==="["&&this.hostname[this.hostname.length-1]==="]";if(!ipv6Hostname){var hostparts=this.hostname.split(/\./);for(var i=0,l=hostparts.length;i<l;i++){var part=hostparts[i];if(!part)continue;if(!part.match(hostnamePartPattern)){var newpart="";for(var j=0,k=part.length;j<k;j++){if(part.charCodeAt(j)>127){newpart+="x"}else{newpart+=part[j]}}if(!newpart.match(hostnamePartPattern)){var validParts=hostparts.slice(0,i);var notHost=hostparts.slice(i+1);var bit=part.match(hostnamePartStart);if(bit){validParts.push(bit[1]);notHost.unshift(bit[2])}if(notHost.length){rest="/"+notHost.join(".")+rest}this.hostname=validParts.join(".");break}}}}if(this.hostname.length>hostnameMaxLen){this.hostname=""}else{this.hostname=this.hostname.toLowerCase()}if(!ipv6Hostname){var domainArray=this.hostname.split(".");var newOut=[];for(var i=0;i<domainArray.length;++i){var s=domainArray[i];newOut.push(s.match(/[^A-Za-z0-9_-]/)?"xn--"+punycode.encode(s):s)}this.hostname=newOut.join(".")}var p=this.port?":"+this.port:"";var h=this.hostname||"";this.host=h+p;this.href+=this.host;if(ipv6Hostname){this.hostname=this.hostname.substr(1,this.hostname.length-2);if(rest[0]!=="/"){rest="/"+rest}}}if(!unsafeProtocol[lowerProto]){for(var i=0,l=autoEscape.length;i<l;i++){var ae=autoEscape[i];var esc=encodeURIComponent(ae);if(esc===ae){esc=escape(ae)}rest=rest.split(ae).join(esc)}}var hash=rest.indexOf("#");if(hash!==-1){this.hash=rest.substr(hash);rest=rest.slice(0,hash)}var qm=rest.indexOf("?");if(qm!==-1){this.search=rest.substr(qm);this.query=rest.substr(qm+1);if(parseQueryString){this.query=querystring.parse(this.query)}rest=rest.slice(0,qm)}else if(parseQueryString){this.search="";this.query={}}if(rest)this.pathname=rest;if(slashedProtocol[lowerProto]&&this.hostname&&!this.pathname){this.pathname="/"}if(this.pathname||this.search){var p=this.pathname||"";var s=this.search||"";this.path=p+s}this.href=this.format();return this};function urlFormat(obj){if(isString(obj))obj=urlParse(obj);if(!(obj instanceof Url))return Url.prototype.format.call(obj);return obj.format()}Url.prototype.format=function(){var auth=this.auth||"";if(auth){auth=encodeURIComponent(auth);auth=auth.replace(/%3A/i,":");auth+="@"}var protocol=this.protocol||"",pathname=this.pathname||"",hash=this.hash||"",host=false,query="";if(this.host){host=auth+this.host}else if(this.hostname){host=auth+(this.hostname.indexOf(":")===-1?this.hostname:"["+this.hostname+"]");if(this.port){host+=":"+this.port}}if(this.query&&isObject(this.query)&&Object.keys(this.query).length){query=querystring.stringify(this.query)}var search=this.search||query&&"?"+query||"";if(protocol&&protocol.substr(-1)!==":")protocol+=":";if(this.slashes||(!protocol||slashedProtocol[protocol])&&host!==false){host="//"+(host||"");if(pathname&&pathname.charAt(0)!=="/")pathname="/"+pathname}else if(!host){host=""}if(hash&&hash.charAt(0)!=="#")hash="#"+hash;if(search&&search.charAt(0)!=="?")search="?"+search;pathname=pathname.replace(/[?#]/g,function(match){return encodeURIComponent(match)});search=search.replace("#","%23");return protocol+host+pathname+search+hash};function urlResolve(source,relative){return urlParse(source,false,true).resolve(relative)}Url.prototype.resolve=function(relative){return this.resolveObject(urlParse(relative,false,true)).format()};function urlResolveObject(source,relative){if(!source)return relative;return urlParse(source,false,true).resolveObject(relative)}Url.prototype.resolveObject=function(relative){if(isString(relative)){var rel=new Url;rel.parse(relative,false,true);relative=rel}var result=new Url;Object.keys(this).forEach(function(k){result[k]=this[k]},this);result.hash=relative.hash;if(relative.href===""){result.href=result.format();return result}if(relative.slashes&&!relative.protocol){Object.keys(relative).forEach(function(k){if(k!=="protocol")result[k]=relative[k]});if(slashedProtocol[result.protocol]&&result.hostname&&!result.pathname){result.path=result.pathname="/"}result.href=result.format();return result}if(relative.protocol&&relative.protocol!==result.protocol){if(!slashedProtocol[relative.protocol]){Object.keys(relative).forEach(function(k){result[k]=relative[k]});result.href=result.format();return result}result.protocol=relative.protocol;if(!relative.host&&!hostlessProtocol[relative.protocol]){var relPath=(relative.pathname||"").split("/");while(relPath.length&&!(relative.host=relPath.shift()));if(!relative.host)relative.host="";if(!relative.hostname)relative.hostname="";if(relPath[0]!=="")relPath.unshift("");if(relPath.length<2)relPath.unshift("");result.pathname=relPath.join("/")}else{result.pathname=relative.pathname}result.search=relative.search;result.query=relative.query;result.host=relative.host||"";result.auth=relative.auth;result.hostname=relative.hostname||relative.host;result.port=relative.port;if(result.pathname||result.search){var p=result.pathname||"";var s=result.search||"";result.path=p+s}result.slashes=result.slashes||relative.slashes;result.href=result.format();return result}var isSourceAbs=result.pathname&&result.pathname.charAt(0)==="/",isRelAbs=relative.host||relative.pathname&&relative.pathname.charAt(0)==="/",mustEndAbs=isRelAbs||isSourceAbs||result.host&&relative.pathname,removeAllDots=mustEndAbs,srcPath=result.pathname&&result.pathname.split("/")||[],relPath=relative.pathname&&relative.pathname.split("/")||[],psychotic=result.protocol&&!slashedProtocol[result.protocol];if(psychotic){result.hostname="";result.port=null;if(result.host){if(srcPath[0]==="")srcPath[0]=result.host;else srcPath.unshift(result.host)}result.host="";if(relative.protocol){relative.hostname=null;relative.port=null;if(relative.host){if(relPath[0]==="")relPath[0]=relative.host;else relPath.unshift(relative.host)}relative.host=null}mustEndAbs=mustEndAbs&&(relPath[0]===""||srcPath[0]==="")}if(isRelAbs){result.host=relative.host||relative.host===""?relative.host:result.host;result.hostname=relative.hostname||relative.hostname===""?relative.hostname:result.hostname;result.search=relative.search;result.query=relative.query;srcPath=relPath}else if(relPath.length){if(!srcPath)srcPath=[];srcPath.pop();srcPath=srcPath.concat(relPath);result.search=relative.search;result.query=relative.query}else if(!isNullOrUndefined(relative.search)){if(psychotic){result.hostname=result.host=srcPath.shift();var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}result.search=relative.search;result.query=relative.query;if(!isNull(result.pathname)||!isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.href=result.format();return result}if(!srcPath.length){result.pathname=null;if(result.search){result.path="/"+result.search}else{result.path=null}result.href=result.format();return result}var last=srcPath.slice(-1)[0];var hasTrailingSlash=(result.host||relative.host)&&(last==="."||last==="..")||last==="";var up=0;for(var i=srcPath.length;i>=0;i--){last=srcPath[i];if(last=="."){srcPath.splice(i,1)}else if(last===".."){srcPath.splice(i,1);up++}else if(up){srcPath.splice(i,1);up--}}if(!mustEndAbs&&!removeAllDots){for(;up--;up){srcPath.unshift("..")}}if(mustEndAbs&&srcPath[0]!==""&&(!srcPath[0]||srcPath[0].charAt(0)!=="/")){srcPath.unshift("")}if(hasTrailingSlash&&srcPath.join("/").substr(-1)!=="/"){srcPath.push("")}var isAbsolute=srcPath[0]===""||srcPath[0]&&srcPath[0].charAt(0)==="/";if(psychotic){result.hostname=result.host=isAbsolute?"":srcPath.length?srcPath.shift():"";var authInHost=result.host&&result.host.indexOf("@")>0?result.host.split("@"):false;if(authInHost){result.auth=authInHost.shift();result.host=result.hostname=authInHost.shift()}}mustEndAbs=mustEndAbs||result.host&&srcPath.length;if(mustEndAbs&&!isAbsolute){srcPath.unshift("")}if(!srcPath.length){result.pathname=null;result.path=null}else{result.pathname=srcPath.join("/")}if(!isNull(result.pathname)||!isNull(result.search)){result.path=(result.pathname?result.pathname:"")+(result.search?result.search:"")}result.auth=relative.auth||result.auth;result.slashes=result.slashes||relative.slashes;result.href=result.format();return result};Url.prototype.parseHost=function(){var host=this.host;var port=portPattern.exec(host);if(port){port=port[0];if(port!==":"){this.port=port.substr(1)}host=host.substr(0,host.length-port.length)}if(host)this.hostname=host};function isString(arg){return typeof arg==="string"}function isObject(arg){return typeof arg==="object"&&arg!==null}function isNull(arg){return arg===null}function isNullOrUndefined(arg){return arg==null}},{punycode:4,querystring:7}],9:[function(require,module,exports){module.exports=function isBuffer(arg){return arg&&typeof arg==="object"&&typeof arg.copy==="function"&&typeof arg.fill==="function"&&typeof arg.readUInt8==="function"}},{}],10:[function(require,module,exports){(function(process,global){var formatRegExp=/%[sdj%]/g;exports.format=function(f){if(!isString(f)){var objects=[];for(var i=0;i<arguments.length;i++){objects.push(inspect(arguments[i]))}return objects.join(" ")}var i=1;var args=arguments;var len=args.length;var str=String(f).replace(formatRegExp,function(x){if(x==="%%")return"%";if(i>=len)return x;switch(x){case"%s":return String(args[i++]);case"%d":return Number(args[i++]);case"%j":try{return JSON.stringify(args[i++])}catch(_){return"[Circular]"}default:return x}});for(var x=args[i];i<len;x=args[++i]){if(isNull(x)||!isObject(x)){str+=" "+x}else{str+=" "+inspect(x)}}return str};exports.deprecate=function(fn,msg){if(isUndefined(global.process)){return function(){return exports.deprecate(fn,msg).apply(this,arguments)}}if(process.noDeprecation===true){return fn}var warned=false;function deprecated(){if(!warned){if(process.throwDeprecation){throw new Error(msg)}else if(process.traceDeprecation){console.trace(msg)}else{console.error(msg)}warned=true}return fn.apply(this,arguments)}return deprecated};var debugs={};var debugEnviron;exports.debuglog=function(set){if(isUndefined(debugEnviron))debugEnviron=process.env.NODE_DEBUG||"";set=set.toUpperCase();if(!debugs[set]){if(new RegExp("\\b"+set+"\\b","i").test(debugEnviron)){var pid=process.pid;debugs[set]=function(){var msg=exports.format.apply(exports,arguments);console.error("%s %d: %s",set,pid,msg)}}else{debugs[set]=function(){}}}return debugs[set]};function inspect(obj,opts){var ctx={seen:[],stylize:stylizeNoColor};if(arguments.length>=3)ctx.depth=arguments[2];if(arguments.length>=4)ctx.colors=arguments[3];if(isBoolean(opts)){ctx.showHidden=opts}else if(opts){exports._extend(ctx,opts)}if(isUndefined(ctx.showHidden))ctx.showHidden=false;if(isUndefined(ctx.depth))ctx.depth=2;if(isUndefined(ctx.colors))ctx.colors=false;if(isUndefined(ctx.customInspect))ctx.customInspect=true;if(ctx.colors)ctx.stylize=stylizeWithColor;return formatValue(ctx,obj,ctx.depth)}exports.inspect=inspect;inspect.colors={bold:[1,22],italic:[3,23],underline:[4,24],inverse:[7,27],white:[37,39],grey:[90,39],black:[30,39],blue:[34,39],cyan:[36,39],green:[32,39],magenta:[35,39],red:[31,39],yellow:[33,39]};inspect.styles={special:"cyan",number:"yellow","boolean":"yellow",undefined:"grey","null":"bold",string:"green",date:"magenta",regexp:"red"};function stylizeWithColor(str,styleType){var style=inspect.styles[styleType];if(style){return"["+inspect.colors[style][0]+"m"+str+"["+inspect.colors[style][1]+"m"}else{return str}}function stylizeNoColor(str,styleType){return str}function arrayToHash(array){var hash={};array.forEach(function(val,idx){hash[val]=true});return hash}function formatValue(ctx,value,recurseTimes){if(ctx.customInspect&&value&&isFunction(value.inspect)&&value.inspect!==exports.inspect&&!(value.constructor&&value.constructor.prototype===value)){var ret=value.inspect(recurseTimes,ctx);if(!isString(ret)){ret=formatValue(ctx,ret,recurseTimes)}return ret}var primitive=formatPrimitive(ctx,value);if(primitive){return primitive}var keys=Object.keys(value);var visibleKeys=arrayToHash(keys);if(ctx.showHidden){keys=Object.getOwnPropertyNames(value)}if(isError(value)&&(keys.indexOf("message")>=0||keys.indexOf("description")>=0)){return formatError(value)}if(keys.length===0){if(isFunction(value)){var name=value.name?": "+value.name:"";return ctx.stylize("[Function"+name+"]","special")}if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}if(isDate(value)){return ctx.stylize(Date.prototype.toString.call(value),"date")}if(isError(value)){return formatError(value)}}var base="",array=false,braces=["{","}"];if(isArray(value)){array=true;braces=["[","]"]}if(isFunction(value)){var n=value.name?": "+value.name:"";base=" [Function"+n+"]"}if(isRegExp(value)){base=" "+RegExp.prototype.toString.call(value)}if(isDate(value)){base=" "+Date.prototype.toUTCString.call(value)}if(isError(value)){base=" "+formatError(value)}if(keys.length===0&&(!array||value.length==0)){return braces[0]+base+braces[1]}if(recurseTimes<0){if(isRegExp(value)){return ctx.stylize(RegExp.prototype.toString.call(value),"regexp")}else{return ctx.stylize("[Object]","special")}}ctx.seen.push(value);var output;if(array){output=formatArray(ctx,value,recurseTimes,visibleKeys,keys)}else{output=keys.map(function(key){return formatProperty(ctx,value,recurseTimes,visibleKeys,key,array)})}ctx.seen.pop();return reduceToSingleString(output,base,braces)}function formatPrimitive(ctx,value){if(isUndefined(value))return ctx.stylize("undefined","undefined");if(isString(value)){var simple="'"+JSON.stringify(value).replace(/^"|"$/g,"").replace(/'/g,"\\'").replace(/\\"/g,'"')+"'";return ctx.stylize(simple,"string")}if(isNumber(value))return ctx.stylize(""+value,"number");if(isBoolean(value))return ctx.stylize(""+value,"boolean");if(isNull(value))return ctx.stylize("null","null")}function formatError(value){return"["+Error.prototype.toString.call(value)+"]"}function formatArray(ctx,value,recurseTimes,visibleKeys,keys){var output=[];for(var i=0,l=value.length;i<l;++i){if(hasOwnProperty(value,String(i))){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,String(i),true))}else{output.push("")}}keys.forEach(function(key){if(!key.match(/^\d+$/)){output.push(formatProperty(ctx,value,recurseTimes,visibleKeys,key,true))}});return output}function formatProperty(ctx,value,recurseTimes,visibleKeys,key,array){var name,str,desc;desc=Object.getOwnPropertyDescriptor(value,key)||{value:value[key]};if(desc.get){if(desc.set){str=ctx.stylize("[Getter/Setter]","special")}else{str=ctx.stylize("[Getter]","special")}}else{if(desc.set){str=ctx.stylize("[Setter]","special")}}if(!hasOwnProperty(visibleKeys,key)){name="["+key+"]"}if(!str){if(ctx.seen.indexOf(desc.value)<0){if(isNull(recurseTimes)){str=formatValue(ctx,desc.value,null)}else{str=formatValue(ctx,desc.value,recurseTimes-1)}if(str.indexOf("\n")>-1){if(array){str=str.split("\n").map(function(line){return"  "+line}).join("\n").substr(2)}else{str="\n"+str.split("\n").map(function(line){return"   "+line}).join("\n")}}}else{str=ctx.stylize("[Circular]","special")}}if(isUndefined(name)){if(array&&key.match(/^\d+$/)){return str}name=JSON.stringify(""+key);if(name.match(/^"([a-zA-Z_][a-zA-Z_0-9]*)"$/)){
name=name.substr(1,name.length-2);name=ctx.stylize(name,"name")}else{name=name.replace(/'/g,"\\'").replace(/\\"/g,'"').replace(/(^"|"$)/g,"'");name=ctx.stylize(name,"string")}}return name+": "+str}function reduceToSingleString(output,base,braces){var numLinesEst=0;var length=output.reduce(function(prev,cur){numLinesEst++;if(cur.indexOf("\n")>=0)numLinesEst++;return prev+cur.replace(/\u001b\[\d\d?m/g,"").length+1},0);if(length>60){return braces[0]+(base===""?"":base+"\n ")+" "+output.join(",\n  ")+" "+braces[1]}return braces[0]+base+" "+output.join(", ")+" "+braces[1]}function isArray(ar){return Array.isArray(ar)}exports.isArray=isArray;function isBoolean(arg){return typeof arg==="boolean"}exports.isBoolean=isBoolean;function isNull(arg){return arg===null}exports.isNull=isNull;function isNullOrUndefined(arg){return arg==null}exports.isNullOrUndefined=isNullOrUndefined;function isNumber(arg){return typeof arg==="number"}exports.isNumber=isNumber;function isString(arg){return typeof arg==="string"}exports.isString=isString;function isSymbol(arg){return typeof arg==="symbol"}exports.isSymbol=isSymbol;function isUndefined(arg){return arg===void 0}exports.isUndefined=isUndefined;function isRegExp(re){return isObject(re)&&objectToString(re)==="[object RegExp]"}exports.isRegExp=isRegExp;function isObject(arg){return typeof arg==="object"&&arg!==null}exports.isObject=isObject;function isDate(d){return isObject(d)&&objectToString(d)==="[object Date]"}exports.isDate=isDate;function isError(e){return isObject(e)&&(objectToString(e)==="[object Error]"||e instanceof Error)}exports.isError=isError;function isFunction(arg){return typeof arg==="function"}exports.isFunction=isFunction;function isPrimitive(arg){return arg===null||typeof arg==="boolean"||typeof arg==="number"||typeof arg==="string"||typeof arg==="symbol"||typeof arg==="undefined"}exports.isPrimitive=isPrimitive;exports.isBuffer=require("./support/isBuffer");function objectToString(o){return Object.prototype.toString.call(o)}function pad(n){return n<10?"0"+n.toString(10):n.toString(10)}var months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];function timestamp(){var d=new Date;var time=[pad(d.getHours()),pad(d.getMinutes()),pad(d.getSeconds())].join(":");return[d.getDate(),months[d.getMonth()],time].join(" ")}exports.log=function(){console.log("%s - %s",timestamp(),exports.format.apply(exports,arguments))};exports.inherits=require("inherits");exports._extend=function(origin,add){if(!add||!isObject(add))return origin;var keys=Object.keys(add);var i=keys.length;while(i--){origin[keys[i]]=add[keys[i]]}return origin};function hasOwnProperty(obj,prop){return Object.prototype.hasOwnProperty.call(obj,prop)}}).call(this,require("_process"),typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./support/isBuffer":9,_process:3,inherits:2}],11:[function(require,module,exports){"use strict";var json_rpc=require("caf_transport").json_rpc;var Queue=exports.Queue=function(caId,options){var queue=[];var that={};var pending=null;var messagesProcessed=0;var lastMessagesProcessed=-1;var safeSetImmediate=function(f){if(typeof window==="undefined"&&setImmediate){setImmediate(f)}else{setTimeout(f,0)}};that.numPending=function(){return queue.length+(pending?1:0)};that.clear=function(){queue=[];pending=null;messagesProcessed=0;lastMessagesProcessed=-1};that.progress=function(){var result=true;if(messagesProcessed===lastMessagesProcessed&&(queue.length>0||pending)){result=false}lastMessagesProcessed=messagesProcessed;return result};var drain=function(webSocket){if(queue.length===0||pending){return}pending=queue.shift();try{webSocket.send(JSON.stringify(pending.req),function(err){if(err){options.log("Error sending request "+err)}})}catch(err){options.log("Exception sending request "+err)}};that.retry=function(webSocket,newToken){if(pending){queue.unshift(pending);pending=null}if(newToken){queue.forEach(function(x){json_rpc.setToken(x.req,newToken)})}drain(webSocket)};that.remoteInvoke=function(webSocket,method,expectedArgs,args){var doThrow=function(msg){var err=new Error(msg);err.method=method;err.args=args;err.expectedArgs=expectedArgs;throw err};if(typeof method!=="string"){doThrow("method name is not a string")}if(!Array.isArray(args)){doThrow("args not an array")}if(!Array.isArray(expectedArgs)){doThrow("expectedArgs not an array")}if(args.length!==expectedArgs.length){doThrow("Unexpected number of arguments")}var cb=args.pop();if(typeof cb!=="function"){doThrow("No callback")}var all=[options.token,caId,options.from,options.session,method].concat(args);var req=json_rpc.request.apply(json_rpc.request,all);queue.push({cb:cb,req:req});drain(webSocket)};that.processAppReply=function(webSocket,reply){if(pending&&pending.req&&reply.id===pending.req.id&&json_rpc.isAppReply(reply)){var cb=pending.cb;var err=json_rpc.getAppReplyError(reply);var data=json_rpc.getAppReplyData(reply);safeSetImmediate(function(){cb(err,data)});pending=null;messagesProcessed=messagesProcessed+1;drain(webSocket);return true}else{return false}};return that}},{caf_transport:15}],12:[function(require,module,exports){"use strict";var urlParser=require("url");var WebSocket=require("ws");var json_rpc=require("caf_transport").json_rpc;var Queue=require("./Queue").Queue;var querystring=require("querystring");var tf=require("./TokenFactory");var TokenFactory=exports.TokenFactory=tf.TokenFactory;var EVENTS=["close","message","open"];var DEFAULT_MAX_RETRIES=1e15;var DEFAULT_RETRY_TIMEOUT_MSEC=1e3;var DEFAULT_TIMEOUT_MSEC=25e3;var Session=exports.Session=function(url,caId,options){var safeSetImmediate=function(f){if(typeof window==="undefined"&&setImmediate){setImmediate(f)}else{setTimeout(f,0)}};var mixin=function(dest,source){source=source||{};Object.keys(source).forEach(function(x){if(source.hasOwnProperty(x)){dest[x]=source[x]}})};var cloneOptions=function(obj){var result={};mixin(result,obj);return result};var tokenFactory=null;options=cloneOptions(options);options.token=options.token||json_rpc.DUMMY_TOKEN;options.from=options.from||json_rpc.DEFAULT_FROM;options.session=options.session||json_rpc.DEFAULT_SESSION;options.log=options.log||function(msg){console.log(msg)};var newHash=function(keys){var result={};keys.forEach(function(key){if(options[key]!==undefined){result[key]=options[key]}});return result};options.newToken=options.newToken||function(msg,cb){try{var root=(0,eval)("this");if(root&&root.location&&root.location.href){var accountsURL=tf.getAccountsURL(options,msg);var accURL=urlParser.parse(accountsURL);var hashObj=newHash(["from","ca","session","disableBackchannel","durationInSec","unrestrictedToken"]);hashObj.goTo=url;accURL.hash="#"+querystring.stringify(hashObj);root.location.href=urlParser.format(accURL)}else{var tokenF=new TokenFactory(options);tokenF.newToken(msg,cb)}}catch(err){cb(err)}};var parsedURL=urlParser.parse(url);if(parsedURL.query){mixin(options,querystring.parse(parsedURL.query))}if(parsedURL.hash&&parsedURL.hash.indexOf("#")===0){mixin(options,querystring.parse(parsedURL.hash.slice(1)))}parsedURL.protocol=parsedURL.protocol==="http:"?"ws:":parsedURL.protocol;parsedURL.protocol=parsedURL.protocol==="https:"?"wss:":parsedURL.protocol;parsedURL.search=null;parsedURL.hash=null;try{var h=json_rpc.splitName(parsedURL.hostname.split(".")[0]);options.appPublisher=options.appPublisher||h[0];options.appLocalName=options.appLocalName||h[1]}catch(err){options.log&&options.log("Warning: hostname in url "+url+" is not of the form"+" appPublisher-appLocalName \n Exception:"+err)}url=urlParser.format(parsedURL);caId=options.ca?options.ca:caId;options.ca=caId;options.newURL=options.newURL||function(msg,cb){var newUrl=json_rpc.redirectDestination(msg);newUrl=parsedURL.protocol+"//"+newUrl;if(newUrl){cb(null,newUrl)}else{var err=new Error("Not a valid redirection message");err.msg=msg;cb(err)}};options.maxRetries=typeof options.maxRetries==="number"?options.maxRetries:DEFAULT_MAX_RETRIES;options.retryTimeoutMsec=typeof options.retryTimeoutMsec==="number"?options.retryTimeoutMsec:DEFAULT_RETRY_TIMEOUT_MSEC;options.timeoutMsec=typeof options.timeoutMsec==="number"?options.timeoutMsec:DEFAULT_TIMEOUT_MSEC;var that={};var currentUrl=url;var listeners={};var closed=false;var webSocket=null;var firstTime=true;var numRetries=0;var timeout=null;that.isClosed=function(){return closed};var queues={rpc:Queue(caId,options),backchannel:Queue(caId,options)};var doQueues=function(f){Object.keys(queues).forEach(function(x){f(x)})};var retry=function(){doQueues(function(x){queues[x].retry(webSocket,options.token)})};var progress=function(){var result=true;doQueues(function(x){if(!queues[x].progress()){result=false}});return result};var addMethods=function(meta){Object.keys(meta).forEach(function(x){that[x]=that[x]||function(){var args=Array.prototype.slice.call(arguments);queues.rpc.remoteInvoke(webSocket,x,meta[x],args)}})};var addBackchannel=function(){var cb=function(err,msg){if(err){if(err.timeout){if(!closed){safeSetImmediate(addBackchannel)}}else{options.log("Error in backchannel : to disable use "+"option 'disableBackchannel=true' Error:"+JSON.stringify(err));that.close(err)}}else{if(!closed){safeSetImmediate(addBackchannel);if(listeners.message&&json_rpc.isNotification(msg)){listeners.message(msg)}else{options.log("Ignoring backchannel message "+JSON.stringify(msg))}}}};if(!options.disableBackchannel&&!closed){queues.backchannel.remoteInvoke(webSocket,"backchannel",["cb"],[cb])}};var startTimeout=function(){return setInterval(function(){if(!progress()){var err=new Error("Timeout");err.timeout=true;that.close(err)}else{numRetries=0}},options.timeoutMsec)};var onopen=function(){var cb=function(err,meta){if(err){var error=new Error("BUG: __external_ca_touch__ "+"should not return app error");error.err=err;that.close(error)}else{addMethods(meta);addBackchannel();timeout=startTimeout();if(listeners.open){listeners.open()}}};if(firstTime){firstTime=false;queues.rpc.remoteInvoke(webSocket,"__external_ca_touch__",["cb"],[cb])}else{retry()}};var recover=function(msg,err){if(!closed){options.log(msg+err);if(numRetries<options.maxRetries){numRetries=numRetries+1;setTimeout(function(){options.log("Retrying..."+numRetries);currentUrl=url;resetWebSocket()},options.retryTimeoutMsec)}else{var error=new Error("Max retries exceeded");error.err=err;error.maxRetriesExceeded=true;that.close(error)}}};var onclose=function(err){recover("Closed WebSocket: error ",err)};var onerror=function(err){recover("Error in websocket ",err)};var onmessage=function(ev){try{var msg=JSON.parse(ev.data);if(!handleMsg(msg)){if(listeners.message&&json_rpc.isNotification(msg)){listeners.message(msg)}else{options.log("Ignoring message "+ev.data)}}}catch(err){options.log("Ignoring unparsable message "+ev.data+" error:"+err)}};var handleMsg=function(msg){if(json_rpc.isSystemError(msg)){if(json_rpc.isRedirect(msg)){var cb=function(err,newUrl){if(err){that.close(err)}else{currentUrl=newUrl;resetWebSocket()}};options.newURL(msg,cb)}else if(json_rpc.isNotAuthenticated(msg)){var cb0=function(err,token){if(err){options.log(err);that.close(err)}else{options.token=token;resetWebSocket()}};options.newToken(msg,cb0)}else if(json_rpc.isErrorRecoverable(msg)&&numRetries<options.maxRetries){numRetries=numRetries+1;setTimeout(function(){currentUrl=url;resetWebSocket()},options.retryTimeoutMsec)}else{options.log(msg);that.close(msg)}return true}else if(json_rpc.isAppReply(msg)){return Object.keys(queues).some(function(x){return queues[x].processAppReply(webSocket,msg)})}else{return false}};var newWebSocket=function(){options.log("new WebSocket:"+currentUrl);webSocket=new WebSocket(currentUrl);webSocket.onclose=onclose;webSocket.onmessage=onmessage;webSocket.onopen=onopen;webSocket.onerror=onerror};var closeWebSocket=function(){if(webSocket){webSocket.onclose=null;webSocket.onmessage=null;webSocket.onopen=null;webSocket.onerror=function(){};var old=webSocket;webSocket=null;try{old.close()}catch(ex){options.log("Exception closing websocket: "+ex)}}};var resetWebSocket=function(){closeWebSocket();newWebSocket()};that.close=function(err){closed=true;Object.keys(queues).forEach(function(x){queues[x].clear()});closeWebSocket();if(timeout){clearInterval(timeout)}if(listeners.close){listeners.close(err)}};that.numPending=function(){var result=0;doQueues(function(x){result=result+queues[x].numPending()});return result};EVENTS.forEach(function(method){var prop="on"+method;var desc={get:function(){return listeners[method]},set:function(newListener){listeners[method]=newListener}};Object.defineProperty(that,prop,desc)});newWebSocket();return that};exports.cbPrint=function(err,data){if(err){console.log("Got error: "+JSON.stringify(err))}else{console.log("Got data: "+JSON.stringify(data))}}},{"./Queue":11,"./TokenFactory":13,caf_transport:15,querystring:7,url:8,ws:18}],13:[function(require,module,exports){var json_rpc=require("caf_transport").json_rpc;var assert=require("assert");var urlParser=require("url");var session=require("./Session");var getAccountsURL=exports.getAccountsURL=function(options,msg){var accURLInMsg=msg&&json_rpc.accountsURL(msg);var accountsURL=options.accountsURL||accURLInMsg;assert.equal(typeof accountsURL,"string","'accountsURL' is not a string");if(accURLInMsg&&accountsURL!==accURLInMsg){options.log&&options.log("Warning: Ignoring accountsURL hint "+accURLInMsg)}return accountsURL};var TokenFactory=exports.TokenFactory=function(options){var that={};var accOptions={from:json_rpc.DEFAULT_FROM,ca:json_rpc.DEFAULT_FROM,disableBackchannel:true,log:options.log,maxRetries:options.maxRetries,retryTimeoutMsec:options.retryTimeoutMsec,timeoutMsec:options.timeoutMsec};assert.equal(typeof options.password,"string","'options.password' is not a string");assert.equal(typeof options.unrestrictedToken,"boolean","'options.unrestrictedToken' is not a boolean");var split=json_rpc.splitName(options.from);var caOwner=split[0];var caLocalName=split[1];assert.equal(typeof caOwner,"string","'caOwner' is not a string");var newConstraint=function(){var durationInSec=options.durationInSec;durationInSec&&assert.ok(typeof durationInSec==="number","'durationInSec' is not a number");typeof durationInSec==="number"&&assert.ok(durationInSec>0,"'durationInSec' is not positive");var result={caOwner:caOwner};if(durationInSec){result.durationInSec=durationInSec}if(!options.unrestrictedToken){assert.equal(typeof caLocalName,"string","'caLocalName' is not a string");assert.equal(typeof options.appPublisher,"string","'options.appPublisher' is not a string");assert.equal(typeof options.appLocalName,"string","'options.appLocalName' is not a string");result.caLocalName=caLocalName;result.appPublisher=options.appPublisher;result.appLocalName=options.appLocalName}return result};that.newToken=function(msg,cb){try{var token=null;var justOnce=true;var client=options.securityClient.clientInstance(caOwner,options.password);var tokenConstraint=newConstraint();var s=new session.Session(getAccountsURL(options,msg),null,accOptions);s.onopen=function(){client.asyncToken(s,tokenConstraint,function(err,data){token=data;s.close(err)})};s.onclose=function(err){if(justOnce){justOnce=false;cb(err,token)}};s.onerror=function(err){if(justOnce){justOnce=false;cb(err,token)}}}catch(err){cb(err)}};return that}},{"./Session":12,assert:1,caf_transport:15,url:8}],14:[function(require,module,exports){"use strict";module.exports=require("./Session")},{"./Session":12}],15:[function(require,module,exports){"use strict";module.exports=require("./lib/main")},{"./lib/main":17}],16:[function(require,module,exports){(function(){"use strict";var json_rpc={};var root,previous_json_rpc;root=this||(0,eval)("this");if(root!==null){previous_json_rpc=root.json_rpc}json_rpc.noConflict=function(){root.json_rpc=previous_json_rpc;return json_rpc};var NAME_SEPARATOR=json_rpc.NAME_SEPARATOR="-";var ERROR_CODES=json_rpc.ERROR_CODES={parseError:-32700,invalidRequest:-32600,methodNotFound:-32601,invalidParams:-32602,internalError:-32603,noSuchCA:-32e3,shutdownCA:-32001,checkpointFailure:-32002,prepareFailure:-32003,exceptionThrown:-32004,commitFailure:-32005,forceRedirect:-32006,notAuthorized:-32007,beginFailure:-32008,notAuthenticated:-32009};var DEFAULT_FROM_ID=json_rpc.DEFAULT_FROM_ID="UNKNOWN";var DEFAULT_FROM_USERNAME=json_rpc.DEFAULT_FROM_USERNAME=json_rpc.NOBODY="NOBODY";var DEFAULT_FROM=json_rpc.DEFAULT_FROM=DEFAULT_FROM_USERNAME+"-"+DEFAULT_FROM_ID;var DEFAULT_SESSION=json_rpc.DEFAULT_SESSION="default";var DEFAULT_REQUEST_ID=json_rpc.DEFAULT_REQUEST_ID=42;var DUMMY_TOKEN=json_rpc.DUMMY_TOKEN="INVALID";json_rpc.SYSTEM_SESSION_ID=DEFAULT_SESSION;var SYSTEM_FROM_ID=json_rpc.SYSTEM_FROM_ID="sys1";var SYSTEM_USERNAME=json_rpc.SYSTEM_USERNAME="!SYSTEM";var SYSTEM_FROM=json_rpc.SYSTEM_FROM=SYSTEM_USERNAME+"-"+SYSTEM_FROM_ID;json_rpc.SYSTEM_TOKEN=DUMMY_TOKEN;var randomId=json_rpc.randomId=function(){var unique=Math.floor(Math.random()*1e16);var result=""+(new Date).getTime()+unique;return result};var isNotification=json_rpc.isNotification=function(msg){return msg&&msg.jsonrpc==="2.0"&&msg.method&&(msg.params&&msg.params.length>0)&&!msg.id};var notification=json_rpc.notification=function(to,from,sessionId,methodName,var_args){var argsArray=Array.prototype.slice.call(arguments);argsArray.splice(0,4);var firstArg={sessionId:sessionId,to:to,from:from};argsArray.unshift(firstArg);return{jsonrpc:"2.0",method:methodName,params:argsArray}};var isRequest=json_rpc.isRequest=function(msg){return msg&&msg.jsonrpc==="2.0"&&msg.method&&(msg.params&&msg.params.length>0)&&msg.id};var request=json_rpc.request=function(token,to,from,sessionId,methodName,var_args){var argsArray=Array.prototype.slice.call(arguments);argsArray.shift();var result=notification.apply(notification,argsArray);result.id=randomId();setToken(result,token);return result};json_rpc.systemRequest=function(to,methodName,var_args){var argsArray=Array.prototype.slice.call(arguments);var varArgsArray=argsArray.slice(2);var args=[json_rpc.SYSTEM_TOKEN,to,json_rpc.SYSTEM_FROM,json_rpc.SYSTEM_SESSION_ID,methodName].concat(varArgsArray);return request.apply(request,args)};var isAppReply=json_rpc.isAppReply=function(msg){return msg&&msg.jsonrpc==="2.0"&&(msg.result&&msg.result.length===3)&&msg.id};var newReplyMeta=function(request){var result;try{result={token:getToken(request),sessionId:getSessionId(request),to:getFrom(request),from:getTo(request)}}catch(err){result={token:DUMMY_TOKEN,sessionId:DEFAULT_SESSION,to:DEFAULT_FROM,from:SYSTEM_FROM}}return result};var appReply=function(request,error,value){error=toErrorObject(error);if(error&&typeof error==="object"){error.request=request}return{jsonrpc:"2.0",result:[newReplyMeta(request),error,value],id:request.id}};var isSystemError=json_rpc.isSystemError=function(msg){return msg&&msg.jsonrpc==="2.0"&&(msg.error&&msg.error.code)&&msg.error.data&&msg.error.data.length===2&&msg.id};var toErrorObject=function(err){if(!err||typeof err!=="object"){return err}else{var obj={};Object.getOwnPropertyNames(err).forEach(function(key){obj[key]=err[key]});return obj}};var systemError=function(request,code,errMsg,err){err=err||new Error(errMsg);err=toErrorObject(err);if(typeof err==="object"){err.request=request}var error={code:code,message:errMsg,data:[newReplyMeta(request),err]};return{jsonrpc:"2.0",error:error,id:request.id||DEFAULT_REQUEST_ID}};var newSysError=json_rpc.newSysError=function(msg,code,errorStr,errorOrg){var error=new Error(errorStr);error.error=toErrorObject(errorOrg);error.name="SystemError";error.msg=msg;error.code=code;error.errorStr=errorStr;return error};var newAppError=json_rpc.newAppError=function(msg,errorStr,errorOrg){var error=new Error(errorStr);error.error=toErrorObject(errorOrg);error.name="AppError";error.msg=msg;error.errorStr=errorStr;return error};var isErrorRecoverable=json_rpc.isErrorRecoverable=function(msg){var code=getSystemErrorCode(msg);return code===ERROR_CODES.noSuchCA||code===ERROR_CODES.shutdownCA||code===ERROR_CODES.checkpointFailure||code===ERROR_CODES.prepareFailure||code===ERROR_CODES.commitFailure||code===ERROR_CODES.beginFailure||code===ERROR_CODES.internalError};var errorReply=function(error){if(error.name==="SystemError"){return systemError(error.msg,error.code,error.errorStr,error.error)}else if(error.name==="AppError"){return appReply(error.msg,error.error,null)}else{var newErr=new Error("errorReply: not  App or System "+JSON.stringify(error));newErr.err=error;throw newErr}};json_rpc.reply=function(error,request,value){if(error){return errorReply(error)}else{return appReply(request,error,value)}};json_rpc.redirect=function(request,errMsg,errOrg){var error=json_rpc.newSysError(request,ERROR_CODES.forceRedirect,errMsg,errOrg);return json_rpc.reply(error)};var isRedirect=json_rpc.isRedirect=function(msg){return isSystemError(msg)&&getSystemErrorCode(msg)===ERROR_CODES.forceRedirect};json_rpc.redirectDestination=function(msg){var result=null;if(isRedirect(msg)&&getSystemErrorData(msg)){result=getSystemErrorData(msg).remoteNode}return result};json_rpc.isNotAuthorized=function(msg){return isSystemError(msg)&&getSystemErrorCode(msg)===ERROR_CODES.notAuthorized};var isNotAuthenticated=json_rpc.isNotAuthenticated=function(msg){return isSystemError(msg)&&getSystemErrorCode(msg)===ERROR_CODES.notAuthenticated};json_rpc.accountsURL=function(msg){var result=null;if(isNotAuthenticated(msg)&&getSystemErrorData(msg)){result=getSystemErrorData(msg).accountsURL}return result};json_rpc.call=function(msg,target,cb){var error;if(typeof target!=="object"){error=newSysError(msg,ERROR_CODES.noSuchCA,"CA not found")}if(!error&&!(isRequest(msg)||isNotification(msg))){error=newSysError(msg,ERROR_CODES.invalidRequest,"Invalid request")}if(!error&&typeof target[msg.method]!=="function"){error=newSysError(msg,ERROR_CODES.methodNotFound,"method not found")}if(!error){try{var args=msg.params.slice(1);var cb1=function(err,data){if(err){err=newAppError(msg,"AppError",err)}cb(err,data)};args.push(cb1);target[msg.method].apply(target,args)}catch(x){error=newSysError(msg,ERROR_CODES.exceptionThrown,"Exception in application code",x);cb(error)}}else{cb(error)}};json_rpc.getMethodArgs=function(msg){if(isRequest(msg)||isNotification(msg)){return msg.params&&msg.params.slice(1)}else{var err=new Error("Invalid msg");err.msg=msg;throw err}};json_rpc.getMethodName=function(msg){if(isRequest(msg)||isNotification(msg)){return msg.method}else{var err=new Error("Invalid msg");err.msg=msg;throw err}};json_rpc.metaFreeze=function(msg){Object.freeze(msg);if(isNotification(msg)||isRequest(msg)){Object.freeze(msg.params);Object.freeze(msg.params[0])}else if(isAppReply(msg)){Object.freeze(msg.result);Object.freeze(msg.result[0])}else if(isSystemError(msg)){Object.freeze(msg.error);Object.freeze(msg.error.data);Object.freeze(msg.error.data[0])}else{var err=new Error("Freezing  badly defined msg");err.msg=msg;throw err}};var getMeta=json_rpc.getMeta=function(msg){if(isRequest(msg)||isNotification(msg)){return msg.params[0]}else if(isAppReply(msg)){return msg.result[0]}else if(isSystemError(msg)){return msg.error.data[0]}else{var err=new Error("No meta in msg");err.msg=msg;throw err}};var setMeta=json_rpc.setMeta=function(msg,meta){if(isRequest(msg)||isNotification(msg)){msg.params[0]=meta}else if(isAppReply(msg)){msg.result[0]=meta}else if(isSystemError(msg)){msg.error.data[0]=meta}else{var err=new Error("Setting metadata in a badly formatted msg.");err.msg=msg;throw err}};var getToken=json_rpc.getToken=function(msg){var meta=getMeta(msg);return meta?meta.token:undefined};var getSessionId=json_rpc.getSessionId=function(msg){var meta=getMeta(msg);return meta?meta.sessionId:undefined};var getTo=json_rpc.getTo=function(msg){var meta=getMeta(msg);return meta?meta.to:undefined};var getFrom=json_rpc.getFrom=function(msg){var meta=getMeta(msg);return meta?meta.from:undefined};var getAppReplyError=json_rpc.getAppReplyError=function(msg){return isAppReply(msg)?msg.result[1]:undefined};var getAppReplyData=json_rpc.getAppReplyData=function(msg){return isAppReply(msg)?msg.result[2]:undefined};var getSystemErrorData=json_rpc.getSystemErrorData=function(msg){return isSystemError(msg)?msg.error.data[1]:undefined};var getSystemErrorCode=json_rpc.getSystemErrorCode=function(msg){return isSystemError(msg)?msg.error.code:undefined};var getSystemErrorMsg=json_rpc.getSystemErrorMsg=function(msg){return isSystemError(msg)?msg.error.message:undefined};var setFrom=json_rpc.setFrom=function(msg,from){var meta=getMeta(msg)||{};meta.from=from;setMeta(msg,meta)};var setTo=json_rpc.setTo=function(msg,to){var meta=getMeta(msg)||{};meta.to=to;setMeta(msg,meta)};var setSessionId=json_rpc.setSessionId=function(msg,sessionId){var meta=getMeta(msg)||{};meta.sessionId=sessionId;setMeta(msg,meta)};var setToken=json_rpc.setToken=function(msg,token){var meta=getMeta(msg)||{};meta.token=token;setMeta(msg,meta)};var splitName=json_rpc.splitName=function(name){var result=name.split(NAME_SEPARATOR);if(result.length===2){return result}else{var err=new Error("Invalid name");err.name=name;throw err}};if(typeof module!=="undefined"&&module.exports){module.exports=json_rpc}else if(typeof define!=="undefined"&&define.amd){define([],function(){return json_rpc})}else{root.json_rpc=json_rpc}})()},{}],17:[function(require,module,exports){"use strict";exports.json_rpc=require("./json_rpc");exports.getModule=function(){return module}},{"./json_rpc":16}],18:[function(require,module,exports){var global=function(){return this}();var WebSocket=global.WebSocket||global.MozWebSocket;module.exports=WebSocket?ws:null;function ws(uri,protocols,opts){var instance;if(protocols){instance=new WebSocket(uri,protocols)}else{instance=new WebSocket(uri)}return instance}if(WebSocket)ws.prototype=WebSocket.prototype},{}],caf_cli:[function(require,module,exports){"use strict";module.exports=require("./lib/main")},{"./lib/main":14}]},{},[]);